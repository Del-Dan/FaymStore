<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAYM Store</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: '#0a0a0a',   // Darker, rich black
                        primary: '#111827',
                        secondary: '#4b5563',
                        accent: '#e11d48',  // Premium Red
                        surface: '#ffffff',
                        offwhite: '#f9fafb',
                    },
                    fontFamily: {
                        sans: ['Plus Jakarta Sans', 'Inter', 'sans-serif'],
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'hover': '0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.01)',
                        'glow': '0 0 15px rgba(225, 29, 72, 0.3)',
                    }
                }
            }
        }
    </script>
    <!-- Fonts: Plus Jakarta Sans -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }
    </style>
</head>

<body class="bg-offwhite text-primary selection:bg-accent selection:text-white">

    <!-- APP CONTAINER -->
    <div id="app" class="relative min-h-screen">

        <!-- HEADER -->
        <header
            class="fixed top-0 w-full z-50 glass-panel border-b border-gray-100/50 shadow-sm transition-all duration-300">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-20">
                    <div class="flex-shrink-0 cursor-pointer group" onclick="App.renderHome()">
                        <h1
                            class="text-3xl font-extrabold tracking-tighter text-brand group-hover:opacity-80 transition-opacity">
                            FAYM<span class="text-accent text-4xl leading-none">.</span>
                        </h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button onclick="App.toggleCart()"
                            class="relative p-3 rounded-full hover:bg-gray-100 transition-all duration-200 group">
                            <i data-lucide="shopping-bag" class="w-6 h-6 text-gray-700 group-hover:text-brand"></i>
                            <span id="cart-badge"
                                class="absolute top-1 right-1 inline-flex items-center justify-center p-1.5 min-w-[20px] h-5 text-xs font-bold leading-none text-white transform bg-accent rounded-full opacity-0 scale-0 transition-all duration-300 shadow-glow">0</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- MAIN CONTENT AREA -->
        <main id="main-content" class="pt-20 min-h-screen">
            <div class="flex flex-col items-center justify-center h-[80vh]">
                <div class="relative w-16 h-16">
                    <div class="absolute inset-0 rounded-full border-4 border-gray-200"></div>
                    <div class="absolute inset-0 rounded-full border-4 border-accent border-t-transparent animate-spin">
                    </div>
                </div>
                <p class="mt-6 text-gray-400 text-sm font-medium tracking-widest uppercase animate-pulse">Loading
                    Experience...</p>
            </div>
        </main>

        <!-- PRODUCT MODAL -->
        <div id="product-modal" class="fixed inset-0 z-[60] hidden" aria-labelledby="modal-title" role="dialog"
            aria-modal="true">
            <div class="fixed inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="App.closeModal()"></div>
            <div class="fixed inset-0 overflow-y-auto">
                <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
                    <div
                        class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-4xl animate-fade-in">
                        <button onclick="App.closeModal()"
                            class="absolute top-5 right-5 z-10 text-gray-400 hover:text-gray-600 bg-white/80 backdrop-blur rounded-full p-2 transition-transform hover:scale-110 shadow-sm">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                        <div id="modal-content"
                            class="bg-white flex flex-col md:flex-row h-full max-h-[90vh] md:max-h-[800px]">
                            <!-- Content Injected Here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CART DRAWER -->
        <div id="cart-drawer" class="fixed inset-0 z-[70] hidden pointer-events-none">
            <div class="fixed inset-0 bg-black/30 backdrop-blur-[2px] transition-opacity pointer-events-auto opacity-0"
                id="cart-backdrop" onclick="App.toggleCart()"></div>
            <div class="fixed inset-y-0 right-0 flex max-w-full pl-0 md:pl-10 pointer-events-none">
                <div class="w-screen max-w-md transform translate-x-full transition duration-500 cubic-bezier(0.16, 1, 0.3, 1) bg-white shadow-2xl pointer-events-auto flex flex-col h-full"
                    id="cart-panel">
                    <div class="flex-1 overflow-y-auto px-6 py-6 border-b border-gray-100">
                        <div class="flex items-start justify-between mb-8">
                            <h2 class="text-2xl font-bold text-gray-900 tracking-tight">Your Bag</h2>
                            <button onclick="App.toggleCart()" class="text-gray-400 hover:text-brand transition-colors">
                                <i data-lucide="x" class="w-7 h-7"></i>
                            </button>
                        </div>
                        <ul id="cart-items" class="space-y-6"></ul>
                    </div>
                    <div class="bg-offwhite px-6 py-8 border-t border-gray-100 shadow-[0_-10px_40px_rgba(0,0,0,0.03)]">
                        <div class="flex justify-between text-base font-medium text-gray-500 mb-2">
                            <p>Subtotal</p>
                            <p id="cart-total" class="text-gray-900">GHS 0.00</p>
                        </div>
                        <p class="text-xs text-gray-400 mb-6">Shipping & taxes calculated at checkout.</p>
                        <button onclick="App.goToCheckout()"
                            class="w-full flex items-center justify-center rounded-xl bg-brand px-6 py-4 text-base font-bold text-white shadow-lg shadow-gray-200 hover:bg-black hover:scale-[1.02] hover:shadow-xl transition-all duration-300">
                            Check Out
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- JAVASCRIPT Logic -->
    <script>
        // ================= CONFIGURATION =================
        const API_URL = "https://script.google.com/macros/s/AKfycbzxG09tYFfcV7ben74vi6TjQXnqZ6DB3hLnW7PVMRoW24BaQpnqvyH6GZ48A8GO38kc/exec";

        // Size Guide Data
        const SIZE_GUIDES = {
            'T-Shirt': {
                headers: ['Size', 'Chest (in)', 'Length (in)'],
                rows: [
                    ['S', '36-38', '27'],
                    ['M', '38-40', '28'],
                    ['L', '40-42', '29'],
                    ['XL', '42-44', '30']
                ]
            },
            'Hoodie': {
                headers: ['Size', 'Chest (in)', 'Sleeve (in)'],
                rows: [
                    ['S', '38-40', '25'],
                    ['M', '40-42', '26'],
                    ['L', '42-44', '27'],
                    ['XL', '44-46', '27.5']
                ]
            },
            'Default': {
                headers: ['Size', 'General Fit'],
                rows: [['S', 'Small'], ['M', 'Medium'], ['L', 'Large'], ['XL', 'Extra Large']]
            }
        };

        const STATE = {
            products: [],
            inventory: {},
            config: {},
            locations: [],
            cart: JSON.parse(localStorage.getItem('faym_cart')) || [],
            currentProduct: null,
            selectedSize: null,
            loading: true
        };

        const App = {
            async init() {
                try {
                    const response = await fetch(`${API_URL}?action=getStoreData`);
                    const data = await response.json();

                    STATE.products = data.products;
                    STATE.config = data.config;
                    STATE.locations = data.locations;

                    data.inventory.forEach(inv => {
                        STATE.inventory[inv.sku_id] = inv;
                    });

                    STATE.loading = false;
                    this.renderHome();
                    this.updateCartUI();
                    lucide.createIcons();
                } catch (error) {
                    console.error("Init Error:", error);
                    this.renderError("We couldn't connect to the store. Please refresh.");
                }
            },

            // --- HELPER: Google Drive Link Formatter ---
            formatImage(url) {
                if (!url) return 'https://via.placeholder.com/400?text=No+Image'; // Fallback
                // Pattern: drive.google.com/file/d/{ID}/view
                const driveRegex = /drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)\//;
                const match = url.match(driveRegex);
                if (match && match[1]) {
                    return `https://drive.google.com/uc?export=view&id=${match[1]}`;
                }
                return url;
            },

            renderHome() {
                const main = document.getElementById('main-content');
                const heroImg = this.formatImage(STATE.config['hero_slide_1']) || 'https://images.unsplash.com/photo-1558769132-cb1aea458c5e?q=80&w=2070&auto=format&fit=crop';
                const heroTitle = STATE.config['hero_text_1'] || 'Elevate Your Style.';

                const displayedProducts = [];
                const parentMap = new Map();
                STATE.products.forEach(p => {
                    if (!parentMap.has(p.parent_code)) {
                        parentMap.set(p.parent_code, p);
                        displayedProducts.push(p);
                    }
                });

                const html = `
                    <div class="relative h-[70vh] w-full overflow-hidden bg-gray-900 group">
                        <div class="absolute inset-0 bg-black/40 z-10"></div>
                        <img src="${heroImg}" class="w-full h-full object-cover transition-transform duration-[2s] scale-100 group-hover:scale-105" alt="Hero">
                        <div class="absolute inset-0 z-20 flex flex-col items-center justify-center text-center px-4">
                            <span class="text-white/80 tracking-[0.2em] text-sm font-bold uppercase mb-4 animate-fade-in" style="animation-delay: 0.1s">Season 2025</span>
                            <h1 class="text-5xl md:text-7xl font-extrabold text-white tracking-tight mb-8 drop-shadow-2xl animate-fade-in" style="animation-delay: 0.2s">${heroTitle}</h1>
                            ${STATE.config['promo_banner_text'] ?
                        `<div class="animate-fade-in" style="animation-delay: 0.3s"><span class="inline-block px-6 py-2 bg-white/10 backdrop-blur-md rounded-full border border-white/20 text-white font-medium text-sm">${STATE.config['promo_banner_text']}</span></div>` : ''}
                            <button onclick="document.getElementById('collection').scrollIntoView({behavior: 'smooth'})" class="mt-10 px-10 py-4 bg-white text-brand font-bold rounded-full hover:bg-gray-100 hover:scale-105 hover:shadow-[0_0_25px_rgba(255,255,255,0.4)] transition-all duration-300 animate-fade-in" style="animation-delay: 0.4s">Explore Collection</button>
                        </div>
                    </div>
                    <div id="collection" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-24">
                        <div class="flex items-center justify-between mb-12">
                            <h2 class="text-3xl font-bold text-gray-900">Latest Drops</h2>
                            <div class="hidden md:flex space-x-2"><span class="w-2 h-2 rounded-full bg-brand"></span><span class="w-2 h-2 rounded-full bg-gray-200"></span></div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-x-8 gap-y-12">
                            ${displayedProducts.map(p => this.buildProductCard(p)).join('')}
                        </div>
                    </div>
                `;
                main.innerHTML = html;
                lucide.createIcons();
            },

            buildProductCard(p) {
                const hasDiscount = p.discount_active === true || p.discount_active === "TRUE";
                const imgUrl = this.formatImage(p.main_image_url);
                return `
                    <div class="group cursor-pointer" onclick="App.openProductModal('${p.sub_code}')">
                        <div class="relative aspect-[3/4] w-full overflow-hidden rounded-2xl bg-gray-100 shadow-sm border border-gray-100">
                            <img src="${imgUrl}" alt="${p.product_name}" class="h-full w-full object-cover object-center transition-transform duration-700 group-hover:scale-110">
                            ${hasDiscount ? `<div class="absolute top-3 left-3 bg-accent text-white text-[10px] font-bold px-2.5 py-1 rounded-full shadow-glow">SALE</div>` : ''}
                            <div class="absolute inset-x-0 bottom-0 p-4 translate-y-full opacity-0 group-hover:translate-y-0 group-hover:opacity-100 transition-all duration-300">
                                <button class="w-full bg-white/95 backdrop-blur text-brand font-bold py-3 rounded-xl shadow-lg hover:bg-brand hover:text-white transition-colors">Quick View</button>
                            </div>
                        </div>
                        <div class="mt-4 px-1">
                            <div class="flex justify-between items-start">
                                <div><h3 class="text-sm text-gray-500 font-medium uppercase tracking-wide mb-1">${p.category || 'Apparel'}</h3><h2 class="text-lg font-bold text-gray-900 leading-tight group-hover:text-accent transition-colors">${p.product_name}</h2></div>
                                <div class="text-right">${hasDiscount ? `<p class="text-accent font-bold">GH₵${p.discount_price}</p><p class="text-xs text-gray-400 line-through">GH₵${p.base_price}</p>` : `<p class="text-brand font-bold">GH₵${p.base_price}</p>`}</div>
                            </div>
                        </div>
                    </div>
                `;
            },

            openProductModal(initialSubCode) {
                const product = STATE.products.find(p => p.sub_code === initialSubCode);
                if (!product) return;
                const siblings = STATE.products.filter(p => p.parent_code === product.parent_code);
                STATE.currentProduct = product;
                STATE.selectedSize = null;
                this.renderModalContent(product, siblings);
                document.getElementById('product-modal').classList.remove('hidden');
                lucide.createIcons();
            },

            renderModalContent(activeVariant, siblings) {
                const content = document.getElementById('modal-content');
                const colorSwatches = siblings.map(sab => {
                    const isActive = sab.sub_code === activeVariant.sub_code;
                    let hex = sab.color_hex;
                    if (hex && !hex.startsWith('#')) hex = '#' + hex;
                    const bgStyle = hex ? `background-color: ${hex};` : `background-image: url('${this.formatImage(sab.main_image_url)}'); background-size: cover;`;
                    return `
                        <button onclick="App.switchVariant('${sab.sub_code}')" class="group relative w-10 h-10 rounded-full shadow-sm transition-all duration-200 ${isActive ? 'ring-2 ring-offset-2 ring-brand scale-110' : 'hover:scale-110 hover:ring-1 hover:ring-gray-300'}" title="${sab.color_name}">
                            <div class="w-full h-full rounded-full border border-gray-200/50" style="${bgStyle}"></div>
                        </button>
                    `;
                }).join('');

                const relatedInventory = Object.values(STATE.inventory).filter(i => i.sub_code === activeVariant.sub_code);
                const standardSizes = ['S', 'M', 'L', 'XL', 'XXL', '3XL'];
                const sizesHtml = standardSizes.map(size => {
                    const item = relatedInventory.find(i => i.size === size);
                    const stock = item ? item.stock_qty : 0;
                    const isAvailable = stock > 0;
                    const isLow = stock > 0 && stock < 5;
                    const isSelected = STATE.selectedSize && STATE.selectedSize.size === size;
                    return `
                        <button onclick="App.selectSize('${size}', ${stock})" class="relative h-12 w-full rounded-lg border font-medium text-sm transition-all duration-200 ${!isAvailable ? 'bg-gray-50 text-gray-300 cursor-not-allowed border-gray-100' : isSelected ? 'bg-brand text-white border-brand shadow-lg scale-105' : 'bg-white text-gray-900 border-gray-200 hover:border-brand hover:bg-gray-50'}" ${!isAvailable ? 'disabled' : ''}>
                            ${size} ${isLow ? '<span class="absolute -top-2 -right-1 flex h-3 w-3"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span><span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span></span>' : ''}
                        </button>
                    `;
                }).join('');

                const hasDiscount = activeVariant.discount_active === true || activeVariant.discount_active === "TRUE";
                const imgUrl = this.formatImage(activeVariant.main_image_url);

                content.innerHTML = `
                    <div class="md:w-1/2 relative bg-gray-100 h-[50vh] md:h-full">
                        <img src="${imgUrl}" class="w-full h-full object-cover">
                        ${hasDiscount ? '<div class="absolute top-4 left-4 bg-accent text-white px-3 py-1 rounded-full text-xs font-bold shadow-soft">SALE</div>' : ''}
                    </div>
                    <div class="md:w-1/2 p-6 md:p-10 flex flex-col h-full overflow-y-auto w-full">
                        <div class="mb-1">
                            <h3 class="text-sm font-bold text-accent uppercase tracking-wider mb-1">${activeVariant.category || 'Collection'}</h3>
                            <h2 class="text-3xl md:text-4xl font-extrabold text-gray-900 tracking-tight mb-2">${activeVariant.product_name}</h2>
                            <div class="flex items-baseline space-x-3 mb-6">
                                ${hasDiscount ? `<span class="text-2xl font-bold text-accent">GH₵${activeVariant.discount_price}</span> <span class="text-lg text-gray-400 line-through">GH₵${activeVariant.base_price}</span>` : `<span class="text-2xl font-bold text-gray-900">GH₵${activeVariant.base_price}</span>`}
                            </div>
                        </div>
                        <div class="mb-8">
                            <label class="block text-sm font-medium text-gray-500 mb-3">Select Color: <span class="text-gray-900 font-bold ml-1">${activeVariant.color_name}</span></label>
                            <div class="flex flex-wrap gap-3">${colorSwatches}</div>
                        </div>
                        <div class="mb-8">
                             <div class="flex justify-between items-end mb-3">
                                <label class="block text-sm font-medium text-gray-500">Select Size</label>
                                <button onclick="App.openSizeGuide('${activeVariant.category}')" class="text-xs font-bold text-gray-400 hover:text-brand underline">Size Guide</button>
                             </div>
                             <div class="grid grid-cols-3 md:grid-cols-4 gap-3">${sizesHtml}</div>
                             <span id="stock-indicator" class="block h-4 mt-2 text-xs font-medium text-accent"></span>
                        </div>
                        <div class="mt-auto pt-6 border-t border-gray-100">
                            <button id="add-btn" onclick="App.addToCart()" disabled class="w-full py-4 rounded-xl font-bold text-lg shadow-lg transition-all duration-300 transform active:scale-95 flex items-center justify-center space-x-2 disabled:bg-gray-200 disabled:text-gray-400 disabled:cursor-not-allowed disabled:shadow-none bg-brand text-white hover:bg-black hover:shadow-xl hover:-translate-y-1"><span>Add to Bag</span><i data-lucide="shopping-bag" class="w-5 h-5"></i></button>
                            <p class="text-center text-xs text-gray-400 mt-4">Free delivery on orders over GH₵ 500. Secure checkout.</p>
                        </div>
                    </div>
                `;
                lucide.createIcons();
            },

            // --- SIZE GUIDE LOGIC ---
            openSizeGuide(category) {
                const guide = SIZE_GUIDES[category] || SIZE_GUIDES['Default'];
                const modalHtml = `
                    <div id="size-guide-modal" class="fixed inset-0 z-[80] flex items-center justify-center p-4">
                        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="document.getElementById('size-guide-modal').remove()"></div>
                        <div class="relative bg-white rounded-2xl p-8 max-w-lg w-full shadow-2xl animate-fade-in">
                            <button onclick="document.getElementById('size-guide-modal').remove()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-6 h-6"></i></button>
                            <h3 class="text-2xl font-bold text-gray-900 mb-6 text-center">${category || 'Standard'} Size Guide</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left text-gray-500">
                                    <thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr>${guide.headers.map(h => `<th class="px-6 py-3 rounded-t-lg">${h}</th>`).join('')}</tr></thead>
                                    <tbody>${guide.rows.map(row => `<tr class="bg-white border-b hover:bg-gray-50">${row.map((cell, i) => `<td class="px-6 py-4 ${i === 0 ? 'font-bold text-gray-900' : ''}">${cell}</td>`).join('')}</tr>`).join('')}</tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                lucide.createIcons();
            },

            switchVariant(subCode) {
                const product = STATE.products.find(p => p.sub_code === subCode);
                const siblings = STATE.products.filter(p => p.parent_code === product.parent_code);
                STATE.currentProduct = product;
                STATE.selectedSize = null;
                this.renderModalContent(product, siblings);
            },

            selectSize(size, stock) {
                STATE.selectedSize = { size, stock };
                const btn = document.getElementById('add-btn');
                btn.disabled = false;
                btn.querySelector('span').textContent = `Add to Bag - ${size}`;
                const ind = document.getElementById('stock-indicator');
                if (stock < 5) ind.textContent = `Only ${stock} items left!`;
                else ind.textContent = 'In Stock';
                const siblings = STATE.products.filter(p => p.parent_code === STATE.currentProduct.parent_code);
                this.renderModalContent(STATE.currentProduct, siblings);
            },

            closeModal() {
                document.getElementById('product-modal').classList.add('hidden');
                STATE.currentProduct = null;
            },

            addToCart() {
                if (!STATE.currentProduct || !STATE.selectedSize) return;
                const p = STATE.currentProduct;
                const s = STATE.selectedSize;
                const invItem = Object.values(STATE.inventory).find(i => i.sub_code === p.sub_code && i.size === s.size);
                const finalSku = invItem ? invItem.sku_id : `${p.sub_code}-${s.size}`;

                const item = {
                    sku_id: finalSku,
                    product_name: p.product_name,
                    sub_code: p.sub_code,
                    size: s.size,
                    color_name: p.color_name,
                    image: this.formatImage(p.main_image_url),
                    price: (p.discount_active === true || p.discount_active === "TRUE") ? p.discount_price : p.base_price,
                    qty: 1,
                    max: s.stock
                };

                const existing = STATE.cart.find(c => c.sku_id === item.sku_id);
                if (existing) {
                    if (existing.qty < existing.max) { existing.qty++; this.showToast("Quantity Updated"); }
                    else { this.showToast("Max Stock Reached", true); }
                } else {
                    STATE.cart.push(item);
                    this.showToast("Added to Bag");
                }
                this.saveCart();
                this.updateCartUI();
                this.closeModal();
                this.toggleCart();
            },

            removeFromCart(sku) {
                STATE.cart = STATE.cart.filter(c => c.sku_id !== sku);
                this.saveCart();
                this.renderCartItems();
                this.updateCartUI();
            },

            updateQty(sku, delta) {
                const item = STATE.cart.find(c => c.sku_id === sku);
                if (!item) return;
                const next = item.qty + delta;
                if (next > item.max) return this.showToast("Max stock reached", true);
                if (next < 1) return this.removeFromCart(sku);
                item.qty = next;
                this.saveCart();
                this.renderCartItems();
                this.updateCartUI();
            },

            toggleCart() {
                const drawer = document.getElementById('cart-drawer');
                const backdrop = document.getElementById('cart-backdrop');
                const panel = document.getElementById('cart-panel');
                if (drawer.classList.contains('hidden')) {
                    drawer.classList.remove('hidden');
                    void drawer.offsetWidth;
                    backdrop.classList.remove('opacity-0');
                    panel.classList.remove('translate-x-full');
                    this.renderCartItems();
                } else {
                    backdrop.classList.add('opacity-0');
                    panel.classList.add('translate-x-full');
                    setTimeout(() => drawer.classList.add('hidden'), 500);
                }
            },

            renderCartItems() {
                const list = document.getElementById('cart-items');
                const totalEl = document.getElementById('cart-total');
                const badge = document.getElementById('cart-badge');
                if (STATE.cart.length === 0) {
                    list.innerHTML = `<div class="flex flex-col items-center justify-center py-20 text-center"><div class="bg-gray-50 p-4 rounded-full mb-4"><i data-lucide="shopping-bag" class="w-8 h-8 text-gray-300"></i></div><p class="text-gray-500 font-medium">Your bag is empty</p><button onclick="App.toggleCart()" class="text-brand text-sm font-bold mt-2 hover:underline">Start Shopping</button></div>`;
                    totalEl.textContent = 'GH₵ 0.00';
                    badge.classList.add('scale-0', 'opacity-0');
                    return;
                }
                const total = STATE.cart.reduce((s, i) => s + (i.price * i.qty), 0);
                totalEl.textContent = `GH₵ ${total.toFixed(2)}`;
                badge.textContent = STATE.cart.reduce((s, i) => s + i.qty, 0);
                badge.classList.remove('scale-0', 'opacity-0');

                list.innerHTML = STATE.cart.map(item => `
                    <li class="flex py-2 group">
                        <div class="h-24 w-24 flex-shrink-0 overflow-hidden rounded-xl border border-gray-100 bg-gray-50"><img src="${item.image}" class="h-full w-full object-cover object-center"></div>
                        <div class="ml-4 flex flex-1 flex-col justify-center">
                            <div><div class="flex justify-between text-base font-bold text-gray-900"><h3 class="line-clamp-1">${item.product_name}</h3><p class="ml-4">GH₵${(item.price * item.qty).toFixed(2)}</p></div><p class="mt-1 text-xs text-gray-500 font-medium uppercase tracking-wide">${item.color_name}  •  SIZE: ${item.size}</p></div>
                            <div class="flex flex-1 items-end justify-between text-sm mt-3">
                                <div class="flex items-center border border-gray-200 rounded-lg bg-white shadow-sm"><button onclick="App.updateQty('${item.sku_id}', -1)" class="w-8 h-8 flex items-center justify-center hover:bg-gray-50 rounded-l-lg transition-colors">-</button><span class="w-8 text-center font-bold text-xs">${item.qty}</span><button onclick="App.updateQty('${item.sku_id}', 1)" class="w-8 h-8 flex items-center justify-center hover:bg-gray-50 rounded-r-lg transition-colors">+</button></div>
                                <button type="button" onclick="App.removeFromCart('${item.sku_id}')" class="text-xs font-semibold text-gray-400 hover:text-accent transition-colors">Remove</button>
                            </div>
                        </div>
                    </li>
                `).join('');
            },

            saveCart() { localStorage.setItem('faym_cart', JSON.stringify(STATE.cart)); },
            updateCartUI() { this.renderCartItems(); },

            showToast(msg, isError = false) {
                const div = document.createElement('div');
                div.className = `fixed top-24 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-full shadow-2xl font-bold text-sm z-[100] animate-fade-in ${isError ? 'bg-red-500 text-white' : 'bg-brand text-white'}`;
                div.textContent = msg;
                document.body.appendChild(div);
                setTimeout(() => div.remove(), 2500);
            },

            goToCheckout() {
                this.toggleCart();
                this.renderCheckoutPagePremium();
            },

            renderCheckoutPagePremium() {
                const main = document.getElementById('main-content');
                const subtotal = STATE.cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
                const deliveryOptions = STATE.locations.map(l => `<option value="${l.delivery_price}">${l.zone_name} - GH₵ ${l.delivery_price}</option>`).join('');

                main.innerHTML = `
                    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12 animate-fade-in">
                        <button onclick="App.renderHome()" class="flex items-center text-sm font-bold text-gray-500 hover:text-brand mb-8 transition-colors"><i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i> Back to Store</button>
                        <div class="flex flex-col lg:flex-row gap-12">
                            <div class="flex-1">
                                <h1 class="text-3xl font-extrabold text-gray-900 mb-8 tracking-tight">Checkout</h1>
                                <form id="checkout-form" onsubmit="App.handleOrderSubmit(event)" class="space-y-8">
                                    <section>
                                        <h3 class="text-sm font-bold text-gray-900 uppercase tracking-widest mb-4 border-b border-gray-100 pb-2">User Details</h3>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                            <input type="text" name="name" required placeholder="Full Name" class="w-full bg-offwhite border border-gray-200 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-brand hover:bg-white transition-all">
                                            <input type="tel" name="phone" required placeholder="Phone (024...)" class="w-full bg-offwhite border border-gray-200 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-brand hover:bg-white transition-all">
                                        </div>
                                    </section>
                                    <section>
                                        <h3 class="text-sm font-bold text-gray-900 uppercase tracking-widest mb-4 border-b border-gray-100 pb-2">Delivery</h3>
                                        <div class="space-y-4">
                                            <select name="location_zone" id="delivery-select" onchange="App.updateOrderTotal()" class="w-full bg-offwhite border border-gray-200 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-brand"><option value="0">Select Zone</option>${deliveryOptions}</select>
                                            <div class="relative"><input type="text" name="location_text" required placeholder="Address / Landmark / GPS" class="w-full bg-offwhite border border-gray-200 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-brand hover:bg-white transition-all"><i data-lucide="map-pin" class="absolute right-4 top-3.5 w-5 h-5 text-gray-400"></i></div>
                                        </div>
                                    </section>
                                    <section>
                                        <h3 class="text-sm font-bold text-gray-900 uppercase tracking-widest mb-4 border-b border-gray-100 pb-2">Payment Mode</h3>
                                        <div class="grid grid-cols-2 gap-4">
                                            <label class="cursor-pointer"><input type="radio" name="payment_method" value="Mobile Money" checked class="peer sr-only"><div class="p-4 rounded-xl border border-gray-200 text-center peer-checked:border-brand peer-checked:bg-gray-50 peer-checked:text-brand transition-all hover:bg-gray-50"><span class="font-bold">Mobile Money</span></div></label>
                                            <label class="cursor-pointer"><input type="radio" name="payment_method" value="Bank Transfer" class="peer sr-only"><div class="p-4 rounded-xl border border-gray-200 text-center peer-checked:border-brand peer-checked:bg-gray-50 peer-checked:text-brand transition-all hover:bg-gray-50"><span class="font-bold">Bank Transfer</span></div></label>
                                        </div>
                                    </section>
                                    <button type="submit" id="place-order-btn" class="w-full bg-brand text-white font-bold text-lg py-5 rounded-xl shadow-lg hover:shadow-xl hover:scale-[1.01] transition-all duration-300">Confirm Order</button>
                                </form>
                            </div>
                            <div class="lg:w-96">
                                <div class="bg-white p-6 rounded-2xl shadow-soft sticky top-24 border border-gray-100">
                                    <h3 class="text-lg font-bold text-gray-900 mb-6">Order Summary</h3>
                                    <div class="space-y-4 mb-6">
                                        <div class="flex justify-between text-gray-500"><span>Subtotal</span><span>GH₵ ${subtotal.toFixed(2)}</span></div>
                                        <div class="flex justify-between text-gray-500"><span>Delivery</span><span id="checkout-delivery">GH₵ 0.00</span></div>
                                        <div class="pt-4 border-t border-gray-100 flex justify-between items-center"><span class="font-bold text-gray-900">Total</span><span id="checkout-total" class="text-2xl font-extrabold text-brand">GH₵ ${subtotal.toFixed(2)}</span></div>
                                    </div>
                                    <div class="flex items-center justify-center space-x-2 text-xs text-gray-400"><i data-lucide="shield-check" class="w-4 h-4"></i><span>Secure Logic Processing</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                window.scrollTo(0, 0);
                lucide.createIcons();
            },

            updateOrderTotal() {
                const select = document.getElementById('delivery-select');
                if (!select) return;
                const deliveryCost = parseFloat(select.value) || 0;
                const subtotal = STATE.cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
                const total = subtotal + deliveryCost;
                document.getElementById('checkout-delivery').textContent = `GH₵ ${deliveryCost.toFixed(2)}`;
                document.getElementById('checkout-total').textContent = `GH₵ ${total.toFixed(2)}`;
            },

            async handleOrderSubmit(e) {
                e.preventDefault();
                const btn = document.getElementById('place-order-btn');
                const formData = new FormData(e.target);
                btn.disabled = true;
                btn.innerHTML = `<span class="animate-pulse">Processing...</span>`;

                const deliveryZoneIndex = document.getElementById('delivery-select').selectedIndex;
                const deliveryZoneName = document.getElementById('delivery-select').options[deliveryZoneIndex].text;

                const payload = {
                    action: 'processOrder',
                    payload: {
                        customerName: formData.get('name'),
                        phone: formData.get('phone'),
                        location: `${deliveryZoneName} | ${formData.get('location_text')}`,
                        deliveryMethod: deliveryZoneName.includes('Pickup') ? 'Pickup' : 'Delivery',
                        paymentMethod: formData.get('payment_method'),
                        items: STATE.cart,
                        grandTotal: document.getElementById('checkout-total').textContent,
                        storeName: "FAYM"
                    }
                };

                try {
                    const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                    const result = await response.json();
                    if (result.success) {
                        STATE.cart = [];
                        this.saveCart();
                        this.updateCartUI();
                        document.getElementById('main-content').innerHTML = `
                             <div class="min-h-screen flex flex-col items-center justify-center text-center p-4">
                                <div class="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mb-6 animate-bounce"><i data-lucide="check" class="w-10 h-10 text-green-600"></i></div>
                                <h1 class="text-4xl font-extrabold text-gray-900 mb-2">Order Confirmed!</h1>
                                <p class="text-gray-500 mb-8 max-w-md">Ref: <span class="font-mono font-bold text-brand bg-gray-100 px-2 py-1 rounded">${result.parentRef}</span></p>
                                <button onclick="window.location.reload()" class="font-bold text-accent hover:underline">Return Home</button>
                             </div>
                        `;
                        lucide.createIcons();
                    } else {
                        alert("Error: " + result.message);
                        btn.disabled = false;
                        btn.textContent = "Try Again";
                    }
                } catch (e) {
                    alert("Network Error: " + e.message);
                    btn.disabled = false;
                    btn.textContent = "Try Again";
                }
            },

            renderError(msg) {
                document.getElementById('main-content').innerHTML = `<div class="p-20 text-center text-red-500 font-bold">${msg}</div>`;
            }
        };

        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>

</html>
